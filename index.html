<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valida√ß√£o de Certificado - Decole Educacional</title>
  <link rel="icon" type="image/png" href="favicondecole.png" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #000000, #1a1a1a);
      margin: 0;
      padding: 0;
      color: #ffffff;
      text-align: center;
    }

    header {
      background-color: #1a1919dc;
      padding: 40px 20px;
      border-bottom: 3px solid #777c7b;
    }

    header img {
      height: 230px;
      margin-bottom: 15px;
    }

    h1 {
      color: #ffffff;
      font-size: 36px;
      margin: 10px 0;
    }

    p {
      color: #cccccc;
    }

    input[type="text"] {
      padding: 12px;
      width: 90%;
      max-width: 400px;
      margin-top: 20px;
      border-radius: 6px;
      border: 2px solid #726d6d;
      font-size: 16px;
    }

    button {
      margin-top: 15px;
      padding: 10px 14px;
      border: none;
      background-color: #f57a07;
      color: white;
      border-radius: 30px;
      font-weight: bold;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #974b08;
    }

    #resultado-validacao {
      margin: 50px auto;
      max-width: 600px;
    }

    footer {
      background-color: #6470706c;
      color: rgb(197, 2, 2);
      padding: 25px;
      margin-top: 60px;
    }

    footer a {
      color: #dfcdbd;
      margin: 0 12px;
      text-decoration: none;
    }

    @media (max-width: 600px) {
      input[type="text"] {
        width: 95%;
      }
      h1 {
        font-size: 26px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="decole-logo.png" alt="Logo Decole Educacional">
    <h1>Ambiente de Valida√ß√£o de Certificado</h1>
    <p>Insira sua chave √∫nica do certificado para validar:</p>
    <input type="text" id="input-chave" placeholder="Ex: abc123xyz" onkeypress="if(event.key === 'Enter') validarCertificado()">
    <br>
    <button id="btn-validar" onclick="validarCertificado()">Validar</button>
  </header>

  <div id="resultado-validacao" aria-live="polite"></div>

  <footer>
    <p>¬© 2025 Decole Educacional. Todos os direitos reservados.</p>
    <p>
      <a href="https://decole.co" target="_blank">Site Oficial</a> |
      <a href="https://www.instagram.com/decolecontabildigital/" target="_blank">Instagram</a> |
      <a href="https://wa.me/5508005803080" target="_blank">WhatsApp: 0800 580 3080</a>
    </p>
  </footer>

<script>
/* ====== PLANILHA (CSV publicado) ======
   Seu link pubhtml convertido para CSV: */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-ApFebCMQ4d_rE8wOvgPFIe7sH5gMY5SUhQtm6HgJQOQP_sjvYDQ1HiYaQ96XWQ/pub?gid=1284708780&single=true&output=csv";

/* ====== Helpers ====== */
const norm = s => (s || "")
  .toString()
  .normalize("NFKC")
  .replace(/\u00A0/g, " ")  // NBSP -> espa√ßo normal
  .replace(/\s+/g, "")      // remove TODOS os espa√ßos
  .toUpperCase().trim();

/* Parser CSV (respeita aspas e v√≠rgulas dentro de campos) */
function parseCSV(text) {
  const rows = [];
  let cur = "", row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i], next = text[i+1];
    if (ch === '"') {
      if (inQuotes && next === '"') { cur += '"'; i++; } // aspas escapada
      else { inQuotes = !inQuotes; }
    } else if (ch === ',' && !inQuotes) {
      row.push(cur); cur = "";
    } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
      if (cur !== "" || row.length) { row.push(cur); rows.push(row); }
      cur = ""; row = [];
      // pular \r\n
      if (ch === '\r' && next === '\n') i++;
    } else {
      cur += ch;
    }
  }
  if (cur !== "" || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

let _cacheMapa = null;

/* Carrega CSV, encontra colunas por cabe√ßalho e monta Map(chave -> dados) */
async function carregarMapaChaves() {
  if (_cacheMapa) return _cacheMapa;

  const resp = await fetch(CSV_URL, { cache: "no-store" });
  if (!resp.ok) throw new Error("Falha ao baixar CSV");
  const texto = await resp.text();
  const matriz = parseCSV(texto);

  // acha a linha de cabe√ßalho (procura por "CHAVES"/"CHAVE")
  let headerIdx = 0;
  for (let i = 0; i < Math.min(6, matriz.length); i++) {
    const vals = matriz[i].map(v => String(v || "").trim().toUpperCase());
    if (vals.includes("CHAVES") || vals.includes("CHAVE")) { headerIdx = i; break; }
  }
  const header = matriz[headerIdx].map(v => String(v || "").trim().toUpperCase());

  const idxChave = header.findIndex(h => h === "CHAVES" || h === "CHAVE");
  const idxNome  = header.findIndex(h => h === "NOME");
  const idxEmail = header.findIndex(h => h === "EMAIL");
  if (idxChave === -1) throw new Error('Coluna "CHAVES" n√£o encontrada.');

  const mapa = new Map();
  for (let i = headerIdx + 1; i < matriz.length; i++) {
    const cols = matriz[i];
    if (!cols || !cols.length) continue;
    const chave = norm(cols[idxChave] || "");
    if (!chave) continue;

    const nome  = (idxNome  >= 0 ? String(cols[idxNome]  || "").trim() : "");
    const email = (idxEmail >= 0 ? String(cols[idxEmail] || "").trim() : "");
    mapa.set(chave, { nome, email });
  }

  _cacheMapa = mapa;
  return mapa;
}

/* UI helpers */
function mostrar(html) {
  const box = document.getElementById("resultado-validacao");
  box.innerHTML = html;
  box.scrollIntoView({ behavior: "smooth" });
}

/* Valida√ß√£o */
async function validarCertificado() {
  const input = document.getElementById("input-chave");
  const chave = norm(input.value);

  if (!chave) {
    return mostrar(`
      <div style="padding:15px;background:#ffe6e6;border:2px solid #e57373;border-radius:10px;color:#000;">
        <h2 style="color:#c62828;">‚ùå Por favor, insira uma chave v√°lida</h2>
      </div>
    `);
  }

  mostrar(`
    <div style="padding:30px;background:#333;border:2px solid #888;border-radius:18px;">
      <h3 style="color:#ddd;">üîé Verificando seu certificado...</h3>
    </div>
  `);

  try {
    const mapa = await carregarMapaChaves();
    if (mapa.has(chave)) {
      const d = mapa.get(chave);
      if (typeof confetti === "function") confetti();
      return mostrar(`
        <div style="padding:30px;background:#2F4F4F;border:2px solid #000;border-radius:16px;color:#fff;">
          <h2 style="color:#FFFAFA;">üéì A Decole Educacional te parabeniza por investir em seu futuro conosco!!!</h2>
          ${d.nome ? `<p style="font-weight:bold;font-size:18px;">${d.nome}</p>` : ""}
          ${d.email ? `<p>${d.email}</p>` : ""}
          <div style="margin-top:20px;">
            <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Selo" width="80"/>
          </div>
          <button onclick="baixarCertificado('${chave}')" style="margin-top:25px;padding:12px 20px;font-size:16px;border-radius:30px;background:#f57a07;color:white;border:none;cursor:pointer;">
            üì• Baixar Certificado
          </button>
        </div>
      `);
    }

    return mostrar(`
      <div style="padding:20px;background:#ffe6e6;border:2px solid #e57373;border-radius:12px;color:#000;">
        <h2 style="color:#c62828;">‚ùå Certificado n√£o encontrado</h2>
        <p>Verifique a chave digitada ou entre em contato com o emissor.</p>
      </div>
    `);
  } catch (e) {
    console.error(e);
    return mostrar(`
      <div style="padding:20px;background:#fffde7;border:2px solid #fdd835;border-radius:12px;color:#000;">
        <h2 style="color:#f9a825;">‚ö†Ô∏è Erro ao validar</h2>
        <p>Tente novamente em instantes. Se persistir, confira a publica√ß√£o CSV.</p>
      </div>
    `);
  }
}

/* Download do PDF (ajuste o caminho se necess√°rio) */
function baixarCertificado(chave) {
  const url = `certificados/${chave}.pdf`; // usa a pasta do pr√≥prio reposit√≥rio
  const link = document.createElement("a");
  link.href = url;
  link.download = `${chave}.pdf`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* Enter para validar no campo */
document.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && document.activeElement?.id === "input-chave") {
    validarCertificado();
  }
});
</script>

</body>
</html>
